#!/usr/bin/env zsh
# ===============================================================
# dotfiles_doctor ‚Äî Zsh Config Health & Performance Analyzer
# ===============================================================

LOGFILE="${1:-$HOME/zshrc-log.json}"
SLOW_THRESHOLD=${SLOW_THRESHOLD:-200}
WARN_THRESHOLD=${WARN_THRESHOLD:-500}

if ! command -v jq >/dev/null 2>&1; then
  echo "‚ùå jq is required (brew install jq)"; exit 1
fi
[[ ! -f "$LOGFILE" ]] && { echo "‚ùå No log file found: $LOGFILE"; exit 1 }

echo
echo "ü©∫  Dotfiles Doctor ‚Äî Startup Diagnostic"
echo "üìÑ  Log: $LOGFILE"
echo "‚öôÔ∏è  Slow threshold: ${SLOW_THRESHOLD}ms | Warn threshold: ${WARN_THRESHOLD}ms"
echo "---------------------------------------------------------------"

jq -r '. | [.label, .duration_ms, .status, .file] | @tsv' "$LOGFILE" |
while IFS=$'\t' read -r label duration exit_code file; do
  color="" reset="\033[0m" emoji="‚úÖ"
  if (( exit_code != 0 )); then color="\033[31m"; emoji="üí•"
  elif (( duration > WARN_THRESHOLD )); then color="\033[31m"; emoji="üî•"
  elif (( duration > SLOW_THRESHOLD )); then color="\033[33m"; emoji="‚ö†Ô∏è "
  else color="\033[32m"; fi
  printf "%b%s %-10s %6sms  (exit:%s)  %s%b\n" "$color" "$emoji" "$label" "$duration" "$exit_code" "$file" "$reset"
done

echo "---------------------------------------------------------------"
echo "üìä Aggregate timings:"
jq -r '
  group_by(.label)
  | map({
      label: .[0].label,
      count: length,
      total: (map(.duration_ms) | add),
      avg: (map(.duration_ms) | add / length)
    })
  | (["label","count","total_ms","avg_ms"], (.[] | [.label, .count, (.total|tostring), (.avg|tostring)]))
  | @tsv
' "$LOGFILE" | column -t -s $'\t'
echo "---------------------------------------------------------------"

total=$(jq '[.[].duration_ms] | add' "$LOGFILE")
fails=$(jq '[.[].status] | map(select(. != 0)) | length' "$LOGFILE")
slows=$(jq "[.[].duration_ms] | map(select(. > $SLOW_THRESHOLD)) | length" "$LOGFILE")

echo
echo "üïí  Total startup time: ${total}ms"
echo "üíÄ  Failed modules:     ${fails}"
echo "üê¢  Slow modules:       ${slows}"
echo

if (( fails > 0 )); then
  echo "‚ùó One or more modules failed to load. Check üí• entries."
elif (( slows > 0 )); then
  echo "‚ö†Ô∏è  Some modules exceeded ${SLOW_THRESHOLD}ms."
else
  echo "‚úÖ  All modules healthy and fast."
fi
echo
