#!/usr/bin/env zsh
# ===============================================================
# call_file â€” Unified file executor with structured JSON logging
# ===============================================================

# Example usage:
#   call_file /Users/ngorse/.dotfiles/zsh/config.zsh
#   call_file /Users/ngorse/.dotfiles/fzf/key-bindings.zsh fzf
#
# Output (to $outfile):
# {"timestamp":1730940810,"file":"/Users/ngorse/.dotfiles/zsh/config.zsh","label":"zsh","exit_code":0,"duration_ms":4}

call_file() {
  local file="$1"
  local label="$2"
  local start end duration exit_code relpath subdir

  # Ensure $outfile exists
  : "${outfile:=$HOME/zshrc-log.json}"

  # Derive label if not provided
  if [[ -z "$label" ]]; then
    relpath="${file#$DOTFILES/}"                # Strip $DOTFILES prefix
    subdir="${relpath%%/*}"                     # Extract subfolder (first path component)
    if [[ "${file:t}" == "config.zsh" ]]; then
      label="${subdir:-config}"                 # Label by subdirectory
    else
      label="${file:t:r}"                       # Otherwise label by filename root
    fi
  fi

  # Record start time (ms precision)
  start=$EPOCHREALTIME

  # Execute target file quietly, preserving exit status
  if [[ -r "$file" ]]; then
    source "$file" >/dev/null 2>&1
    exit_code=$?
  else
    exit_code=126
  fi

  # Compute duration in milliseconds
  end=$EPOCHREALTIME
  duration=$(printf "%.0f" "$(echo "($end - $start) * 1000" | bc -l 2>/dev/null)")

  # Write structured JSON record
  print -r -- "{\"timestamp\":$(date +%s),\"file\":\"$file\",\"label\":\"$label\",\"exit_code\":$exit_code,\"duration_ms\":${duration:-0}}" >>"$outfile"
}
