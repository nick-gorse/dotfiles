#!/bin/bash
host='127.0.0.1'
remote_host='10.237.97.170'
hostdir=$HOME/.dotfiles/ssh
ports=(`cat $hostdir/ports.txt`)

if [[ ! "{$(/opt/cisco/anyconnect/bin/vpn status)[0]}" == *"Disconnected"* ]]; then
  if [[ -e $HOME/.ssh/ctl_chan/$USER@$remote_host:22 ]]; then
    for port in ${ports[@]}; do
      if [[ $port -lt 999 ]]; then act_port=$port; port=$((port + 7000)); fi
        r=$(bash -c 'exec 3<> /dev/tcp/'$host'/'$port';echo $?' 2>/dev/null)
        if [ ! "$r" = "0" ]; then
          echo "Add to Connection" 
          ssh -O forward -S$HOME/.ssh/ctl_chan/$USER@$remote_host:22 -L $port:127.0.0.1:$act_port tunnel
        fi
    done
  else
    echo "New Connection" 
    ssh -N -f tunnel
  fi
fi
